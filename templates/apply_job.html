{% extends "base.html" %}

{% block title %}Apply for Job - Hiring Portal{% endblock %}

{% block extra_css %}
<style>
    .application-container {
        max-width: 800px;
        margin: 0 auto;
        padding: var(--spacing-xl) 0;
    }
    
    .job-info {
        background-color: var(--white);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        margin-bottom: var(--spacing-xl);
        border-left: 4px solid var(--primary-color);
    }
    
    .application-form {
        background-color: var(--white);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-lg);
    }
    
    .form-actions {
        display: flex;
        gap: var(--spacing-md);
        justify-content: flex-end;
        margin-top: var(--spacing-xl);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--gray-200);
    }
    
    .file-upload-area {
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-md);
        padding: var(--spacing-xl);
        text-align: center;
        background-color: var(--gray-50);
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .file-upload-area:hover {
        border-color: var(--primary-color);
        background-color: var(--primary-light);
    }
    
    .file-upload-area.dragover {
        border-color: var(--primary-color);
        background-color: var(--primary-light);
    }
    
    .file-info {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background-color: var(--gray-100);
        border-radius: var(--radius-md);
        display: none;
    }
    
    .file-info.show {
        display: block;
    }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        color: var(--muted-text);
        text-decoration: none;
        margin-bottom: var(--spacing-lg);
        transition: color 0.2s ease;
    }
    
    .back-link:hover {
        color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="application-container">
        <!-- Back Link -->
        <a href="{{ url_for('student_dashboard') }}" class="back-link">
            ‚Üê Back to Job Listings
        </a>
        
        <!-- Job Information -->
        <div class="job-info" id="job-info">
            <h2 id="job-title">Loading job details...</h2>
            <div class="job-company" id="job-company"></div>
            <div class="job-meta" id="job-meta"></div>
            <div class="job-description" id="job-description"></div>
        </div>
        
        <!-- Application Form -->
        <div class="application-form">
            <h3>Application Form</h3>
            <p style="color: var(--muted-text); margin-bottom: var(--spacing-xl);">
                Please fill out the form below to apply for this position. Make sure all information is accurate and complete.
            </p>
            
            <form id="application-form" enctype="multipart/form-data">
                <!-- Personal Information -->
                <div class="form-section">
                    <h4>Personal Information</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="first-name">First Name *</label>
                            <input type="text" id="first-name" name="first_name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="last-name">Last Name *</label>
                            <input type="text" id="last-name" name="last_name" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="email">Email Address *</label>
                            <input type="email" id="email" name="email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="phone">Phone Number *</label>
                            <input type="tel" id="phone" name="phone" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="address">Address</label>
                        <textarea id="address" name="address" class="form-textarea" rows="3" placeholder="Your current address"></textarea>
                    </div>
                </div>
                
                <!-- Educational Background -->
                <div class="form-section">
                    <h4>Educational Background</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="college">University/College *</label>
                            <input type="text" id="college" name="college" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="degree">Degree *</label>
                            <input type="text" id="degree" name="degree" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="major">Major/Field of Study *</label>
                            <input type="text" id="major" name="major" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="gpa">GPA/CGPA</label>
                            <input type="text" id="gpa" name="gpa" class="form-input" placeholder="e.g., 8.5/10 or 3.5/4.0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="graduation-year">Expected Graduation Year *</label>
                            <select id="graduation-year" name="graduation_year" class="form-select" required>
                                <option value="">Select Year</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="experience">Relevant Experience (Years)</label>
                            <select id="experience" name="experience" class="form-select">
                                <option value="0">No Experience</option>
                                <option value="1">1 Year</option>
                                <option value="2">2 Years</option>
                                <option value="3">3 Years</option>
                                <option value="4">4+ Years</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Skills and Additional Information
                <div class="form-section">
                    <h4>Skills and Additional Information</h4>
                    
                    <div class="form-group">
                        <label class="form-label" for="skills">Technical Skills *</label>
                        <textarea id="skills" name="skills" class="form-textarea" rows="3" required placeholder="List your technical skills, programming languages, tools, etc."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="projects">Projects/Portfolio</label>
                        <textarea id="projects" name="projects" class="form-textarea" rows="3" placeholder="Describe any relevant projects, internships, or portfolio work"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="cover-letter">Cover Letter</label>
                        <textarea id="cover-letter" name="cover_letter" class="form-textarea" rows="5" placeholder="Write a brief cover letter explaining why you're interested in this position and how you're a good fit"></textarea>
                    </div>
                </div> -->
                
                <!-- Resume Upload -->
                <div class="form-section">
                    <h4>Resume Upload *</h4>
                    <p style="color: var(--muted-text); margin-bottom: var(--spacing-lg);">
                        Please upload your resume in PDF or Word format (max 5MB).
                    </p>
                    
                    <div class="file-upload-area" id="file-upload-area">
                        <div class="file-upload-icon">üìÑ</div>
                        <h4>Drop your resume here or click to browse</h4>
                        <p style="color: var(--muted-text); margin-bottom: var(--spacing-md);">
                            Supported formats: PDF, DOC, DOCX
                        </p>
                        <input type="file" id="resume-file" name="resume" accept=".pdf,.doc,.docx" required style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('resume-file').click()">
                            Choose File
                        </button>
                    </div>
                    
                    <div class="file-info" id="file-info">
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <span>üìÑ</span>
                            <span id="file-name"></span>
                            <span id="file-size" style="color: var(--muted-text);"></span>
                            <button type="button" class="btn btn-sm" onclick="removeFile()" style="margin-left: auto;">Remove</button>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        Submit Application
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/supabase.js') }}"></script>
<script>
// Application Form JavaScript
let selectedFile = null;
const jobId = '{{ job_id }}';

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    loadJobDetails();
    setupFormValidation();
    setupFileUpload();
});

// Load job details
async function loadJobDetails() {
    try {
        const result = await window.SupabaseServices.JobService.fetchJobById(jobId);
        
        if (result.success && result.job) {
            displayJobDetails(result.job);
        } else {
            // Fallback to sample data
            displayJobDetails(getSampleJob());
        }
    } catch (error) {
        console.error('Error loading job details:', error);
        displayJobDetails(getSampleJob());
    }
}

// Get sample job data
function getSampleJob() {
    return {
        id: jobId,
        title: 'Software Engineer - Frontend',
        company: 'TechCorp Solutions',
        location: 'Bangalore',
        type: 'Full-time',
        level: 'Entry Level',
        description: 'We are looking for a talented Frontend Developer to join our team. You will be responsible for building user-facing features and ensuring a great user experience.',
        requirements: 'React, JavaScript, HTML/CSS, Git',
        posted_date: '2024-01-15'
    };
}

// Display job details
function displayJobDetails(job) {
    document.getElementById('job-title').textContent = job.title;
    document.getElementById('job-company').textContent = job.company;
    document.getElementById('job-meta').innerHTML = `
        <span>üìç ${job.location}</span>
        <span>üíº ${job.type}</span>
        <span>‚≠ê ${job.level}</span>
    `;
    document.getElementById('job-description').textContent = job.description;
}

// Setup form validation
function setupFormValidation() {
    const form = document.getElementById('application-form');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!window.HiringPortal.validateForm('application-form')) {
            return;
        }
        
        if (!selectedFile) {
            window.HiringPortal.showAlert('Please upload your resume', 'error');
            return;
        }
        
        await submitApplication();
    });
}

// Setup file upload
function setupFileUpload() {
    const fileInput = document.getElementById('resume-file');
    const uploadArea = document.getElementById('file-upload-area');
    
    // Click to upload
    uploadArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        handleFileSelect(e.target.files[0]);
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFileSelect(e.dataTransfer.files[0]);
    });
}

// Handle file selection
function handleFileSelect(file) {
    if (!file) return;
    
    // Validate file
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
        window.HiringPortal.showAlert('File size must be less than 5MB', 'error');
        return;
    }
    
    const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    if (!allowedTypes.includes(file.type)) {
        window.HiringPortal.showAlert('Please upload a PDF or Word document', 'error');
        return;
    }
    
    selectedFile = file;
    displayFileInfo(file);
}

// Display file information
function displayFileInfo(file) {
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    
    fileName.textContent = file.name;
    fileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
    fileInfo.classList.add('show');
}

// Remove file
function removeFile() {
    selectedFile = null;
    document.getElementById('resume-file').value = '';
    document.getElementById('file-info').classList.remove('show');
}

// Submit application
async function submitApplication() {
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.innerHTML;
    
    try {
        // Show loading state
        window.HiringPortal.showLoading(submitBtn);
        
        // Prepare form data for the backend
        const formData = new FormData();
        
        // Add required fields for the backend API
        formData.append('job_id', jobId);
        formData.append('name', document.getElementById('first-name').value + ' ' + document.getElementById('last-name').value);
        formData.append('email', document.getElementById('email').value);
        formData.append('phone', document.getElementById('phone').value);
        formData.append('college', document.getElementById('college').value);
        formData.append('file', selectedFile); // Add the resume file
        
        // Submit application directly to backend
        const response = await fetch('/api/apply', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.ok) {
            window.HiringPortal.showAlert('Application submitted successfully!', 'success');
            
            // Redirect to dashboard after a delay
            setTimeout(() => {
                window.location.href = '/student';
            }, 2000);
        } else {
            throw new Error(result.error || 'Failed to submit application');
        }
        
    } catch (error) {
        console.error('Error submitting application:', error);
        window.HiringPortal.showAlert('Failed to submit application. Please try again.', 'error');
    } finally {
        window.HiringPortal.hideLoading(submitBtn, originalText);
    }
}
</script>
{% endblock %}
